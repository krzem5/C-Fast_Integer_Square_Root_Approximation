#include <isqrt.h>
#include <stdint.h>



static const uint32_t _sqrt_values[192]={
	0x02000080,0x01fc0781,0x01f81f82,0x01f44683,0x01f07c84,0x01ecc085,0x01e91386,0x01e57387,
	0x01e1e188,0x01de5d89,0x01dae68a,0x01d77b8b,0x01d41d8c,0x01d0cb8d,0x01cd858e,0x01ca4b8f,
	0x01c71c90,0x01c71c90,0x01c3f891,0x01c0e092,0x01bdd293,0x01bacf94,0x01b7d695,0x01b4e896,
	0x01b20397,0x01b20397,0x01af2898,0x01ac5799,0x01a98e9a,0x01a6d09b,0x01a41a9c,0x01a41a9c,
	0x01a16d9d,0x019ec89e,0x019c2d9f,0x019999a0,0x019999a0,0x01970ea1,0x01948ba2,0x01920fa3,
	0x018f9ca4,0x018f9ca4,0x018d30a5,0x018acba6,0x01886ea7,0x01886ea7,0x018618a8,0x0183c9a9,
	0x018181aa,0x018181aa,0x017f40ab,0x017d05ac,0x017ad2ad,0x017ad2ad,0x0178a4ae,0x01767daf,
	0x01745db0,0x01745db0,0x017242b1,0x01702eb2,0x016e1fb3,0x016e1fb3,0x016c16b4,0x016a13b5,
	0x016a13b5,0x016816b6,0x01661eb7,0x01661eb7,0x01642cb8,0x01623fb9,0x016058ba,0x016058ba,
	0x015e75bb,0x015c98bc,0x015c98bc,0x015ac0bd,0x0158edbe,0x0158edbe,0x01571ebf,0x015555c0,
	0x015555c0,0x015390c1,0x0151d0c2,0x0151d0c2,0x015015c3,0x014e5ec4,0x014e5ec4,0x014cabc5,
	0x014afdc6,0x014afdc6,0x014953c7,0x0147aec8,0x0147aec8,0x01460cc9,0x01460cc9,0x01446fca,
	0x0142d6cb,0x0142d6cb,0x014141cc,0x013fb0cd,0x013fb0cd,0x013e22ce,0x013e22ce,0x013c99cf,
	0x013b13d0,0x013b13d0,0x013991d1,0x013813d2,0x013813d2,0x013698d3,0x013698d3,0x013521d4,
	0x0133aed5,0x0133aed5,0x01323ed6,0x01323ed6,0x0130d1d7,0x012f68d8,0x012f68d8,0x012e02d9,
	0x012e02d9,0x012c9fda,0x012b40db,0x012b40db,0x0129e4dc,0x0129e4dc,0x01288bdd,0x01288bdd,
	0x012735de,0x0125e2df,0x0125e2df,0x012492e0,0x012492e0,0x012345e1,0x012345e1,0x0121fbe2,
	0x0120b4e3,0x0120b4e3,0x011f70e4,0x011f70e4,0x011e2ee5,0x011e2ee5,0x011cf0e6,0x011cf0e6,
	0x011bb4e7,0x011a7be8,0x011a7be8,0x011945e9,0x011945e9,0x011811ea,0x011811ea,0x0116e0eb,
	0x0116e0eb,0x0115b1ec,0x011485ed,0x011485ed,0x01135cee,0x01135cee,0x011235ef,0x011235ef,
	0x011111f0,0x011111f0,0x010feff1,0x010feff1,0x010ecff2,0x010ecff2,0x010db2f3,0x010db2f3,
	0x010c97f4,0x010c97f4,0x010b7ef5,0x010a68f6,0x010a68f6,0x010953f7,0x010953f7,0x010842f8,
	0x010842f8,0x010732f9,0x010732f9,0x010624fa,0x010624fa,0x010519fb,0x010519fb,0x010410fc,
	0x010410fc,0x010309fd,0x010309fd,0x010204fe,0x010204fe,0x010101ff,0x010101ff,0x010101ff
};



#ifdef __arm__
static const uint8_t _shift_values[32]={
	30,22,30,20,18,10,28,2,20,16,14,12,8,6,28,0,
	22,18,10,2,16,14,6,24,12,4,8,24,4,26,26,0
};
#endif



uint32_t isqrt(uint32_t x){
	x|=1;
#ifdef __arm__
	uint32_t t=x|(x>>1);
	t|=t>>2;
	t|=t>>4;
	t|=t>>8;
	uint8_t shift=_shift_values[((t|(t>>16))*0x07c4acdd)>>27];
	x=(x<<shift)>>16;
	t=_sqrt_values[(x>>8)-64];
	return (((t&0xff)<<7)+((x*(t>>16)+((x*(t&0xffff))>>16))>>9))>>(shift>>1);
#else
	uint8_t shift=__builtin_clz(x)&0xfe;
	x<<=shift;
	uint32_t t=_sqrt_values[(x>>24)-64];
	return (((t&0xff)<<7)+((uint32_t)((((uint64_t)x)*t)>>41)))>>(shift>>1);
#endif
}
